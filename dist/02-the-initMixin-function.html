<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>initMixin 函数 | Vue.js-Source-Code-line-by-line</title>
    <meta name="description" content="逐行级深入探究 Vue.js 源码">
    
    
    <link rel="preload" href="/Vue.js-Source-Code-line-by-line/assets/css/0.styles.ef937687.css" as="style"><link rel="preload" href="/Vue.js-Source-Code-line-by-line/assets/js/app.4e4e2843.js" as="script"><link rel="preload" href="/Vue.js-Source-Code-line-by-line/assets/js/4.904b87d0.js" as="script"><link rel="prefetch" href="/Vue.js-Source-Code-line-by-line/assets/js/10.afce35a8.js"><link rel="prefetch" href="/Vue.js-Source-Code-line-by-line/assets/js/11.cb2e1539.js"><link rel="prefetch" href="/Vue.js-Source-Code-line-by-line/assets/js/12.ce1e94ad.js"><link rel="prefetch" href="/Vue.js-Source-Code-line-by-line/assets/js/2.f322ea4b.js"><link rel="prefetch" href="/Vue.js-Source-Code-line-by-line/assets/js/3.954533b9.js"><link rel="prefetch" href="/Vue.js-Source-Code-line-by-line/assets/js/5.9fa285a9.js"><link rel="prefetch" href="/Vue.js-Source-Code-line-by-line/assets/js/6.6993f55b.js"><link rel="prefetch" href="/Vue.js-Source-Code-line-by-line/assets/js/7.b3bd69fd.js"><link rel="prefetch" href="/Vue.js-Source-Code-line-by-line/assets/js/8.8aa964e1.js"><link rel="prefetch" href="/Vue.js-Source-Code-line-by-line/assets/js/9.a9a7f70b.js">
    <link rel="stylesheet" href="/Vue.js-Source-Code-line-by-line/assets/css/0.styles.ef937687.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Vue.js-Source-Code-line-by-line/" class="home-link router-link-active"><!----> <span class="site-name">Vue.js-Source-Code-line-by-line</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/ohhoney1/Vue.js-Source-Code-line-by-line" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"> <a href="https://github.com/ohhoney1/Vue.js-Source-Code-line-by-line" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/Vue.js-Source-Code-line-by-line/" class="sidebar-link">首页</a></li><li><a href="/Vue.js-Source-Code-line-by-line/01-the-vue-object-constructor-function.html" class="sidebar-link">01. Vue 的构造函数</a></li><li><a href="/Vue.js-Source-Code-line-by-line/02-the-initMixin-function.html" class="active sidebar-link">02. initMixin 函数</a></li><li><a href="/Vue.js-Source-Code-line-by-line/03-the-mergeOptions-function-1.html" class="sidebar-link">03. mergeOptions 函数(1)</a></li><li><a href="/Vue.js-Source-Code-line-by-line/04-the-dedupe-function.html" class="sidebar-link">04. dedupe 函数</a></li><li><a href="/Vue.js-Source-Code-line-by-line/05-update-plan.html" class="sidebar-link">05. 更新计划</a></li><li><a href="/Vue.js-Source-Code-line-by-line/06-the-mergeOptions-function-2.html" class="sidebar-link">06. mergeOptions 函数(2)</a></li><li><a href="/Vue.js-Source-Code-line-by-line/07-the-mergeOptions-function-3.html" class="sidebar-link">07. mergeOptions 函数(3)</a></li><li><a href="/Vue.js-Source-Code-line-by-line/08-the-cached-function.html" class="sidebar-link">08. cached 函数</a></li></ul> </div> <div class="page"> <div class="content"><h2 id="initmixin-函数"><a href="#initmixin-函数" aria-hidden="true" class="header-anchor">#</a> initMixin 函数</h2> <p><code>._init</code> 方法定义在 <code>initMixin</code> 函数里。在 Vue 对象构造函数被定义后，<code>initMixin</code> 等其他一系列函数直接地被调用：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">initMixin</span><span class="token punctuation">(</span>vue<span class="token punctuation">)</span>
<span class="token function">stateMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token function">eventsMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token function">lifecycleMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token function">renderMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
</code></pre></div><p><code>initMixin</code> 函数很简单，参数为 Vue 对象构造函数，并在它的原型上添加一个 <code>._init</code> 方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">function</span> <span class="token function">initMixin</span> <span class="token punctuation">(</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// a uid</span>
    vm<span class="token punctuation">.</span>_uid <span class="token operator">=</span> uid<span class="token operator">++</span>

    <span class="token keyword">let</span> startTag<span class="token punctuation">,</span> endTag
    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      startTag <span class="token operator">=</span> <span class="token template-string"><span class="token string">`vue-perf-start:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
      endTag <span class="token operator">=</span> <span class="token template-string"><span class="token string">`vue-perf-end:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
      <span class="token function">mark</span><span class="token punctuation">(</span>startTag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// a flag to avoid this being observed</span>
    vm<span class="token punctuation">.</span>_isVue <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">// merge options</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>_isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// optimize internal component instantiation</span>
      <span class="token comment">// since dynamic options merging is pretty slow, and none of the</span>
      <span class="token comment">// internal component options needs special treatment.</span>
      <span class="token function">initInternalComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
        <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>
        options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        vm
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* istanbul ignore else */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">initProxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>_renderProxy <span class="token operator">=</span> vm
    <span class="token punctuation">}</span>
    <span class="token comment">// expose real self</span>
    vm<span class="token punctuation">.</span>_self <span class="token operator">=</span> vm
    <span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span>
    <span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve injections before data/props</span>
    <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve provide after data/props</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span>

    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>_name <span class="token operator">=</span> <span class="token function">formatComponentName</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token function">mark</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
      <span class="token function">measure</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`vue </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> init`</span></span><span class="token punctuation">,</span> startTag<span class="token punctuation">,</span> endTag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在函数外部，顶级作用域下，设置一个变量 <code>uid</code> ，作为一个增量的计数器。 并在每次创建一个新的 <code>Vue</code> 实例且调用 <code>._init</code> 方法时，设置为 <code>Vue</code> 实例的一个属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">function</span> <span class="token function">initMixin</span> <span class="token punctuation">(</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">]</span>
    <span class="token comment">// a uid</span>
    vm<span class="token punctuation">.</span>_uid <span class="token operator">=</span> uid<span class="token operator">++</span>
    <span class="token punctuation">[</span><span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>._init</code> 方法为 <code>this</code> 设置了一个辅助变量。即通过 <code>vm = this</code> 来保存 <code>this</code> 关键字的当前作用域，以方便后面使用。</p> <p>接下来，<code>._init</code> 方法设置了一个对性能的检查。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> startTag<span class="token punctuation">,</span> endTag
<span class="token comment">/* istanbul ignore if */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  startTag <span class="token operator">=</span> <span class="token template-string"><span class="token string">`vue-perf-start:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  endTag <span class="token operator">=</span> <span class="token template-string"><span class="token string">`vue-perf-end:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  <span class="token function">mark</span><span class="token punctuation">(</span>startTag<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>._init</code> 方法声明了两个变量：<code>startTag</code> 和 <code>endTag</code> 。</p> <hr> <h3 id="istanbul"><a href="#istanbul" aria-hidden="true" class="header-anchor">#</a> Istanbul</h3> <p>然后你会注意到一个奇怪的注释：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* istanbul ignore if */</span>
</code></pre></div><p><a href="https://github.com/gotwarlost/istanbul" target="_blank" rel="noopener noreferrer">Istanbul<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是“另一种 JS 代码覆盖率工具，当运行测试时，它可以通过模块加载钩子透明地计算语句、行、函数和分支的覆盖率。”。这个覆盖率提示告诉 <code>Istanbul</code> 忽略 <code>if</code> 语句。</p> <p><code>if</code> 语句里第一个检测的是当前环境不是开发环境： <code>process.env.NODE_ENV !== production</code>。</p> <p>然后检测 <code>config.performance</code> 是否设置为 <code>true</code>。</p> <p>因为对象 <code>config</code> 在其他地方定义，且默认值为 <code>false</code>，所以我们将跳到 config.js 文件（src/core/config）。如注释所讲，属性 <code>object.performance</code> 的值决定了是否要记录 Vue 的性能：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">]</span>
  <span class="token comment">/**
   * Whether to record perf
   */</span>
  performance<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>回到方法 <code>Vue.prototype._init</code> 上，if 语句里下一检测是名为 <code>mark</code> 的变量。因为在源码里， mark 定义在其他地方，不妨看下（src/core/util/perf）：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> mark
<span class="token keyword">let</span> measure

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> perf <span class="token operator">=</span> inBrowser <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>performance
  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    perf <span class="token operator">&amp;&amp;</span>
    perf<span class="token punctuation">.</span>mark <span class="token operator">&amp;&amp;</span>
    perf<span class="token punctuation">.</span>measure <span class="token operator">&amp;&amp;</span>
    perf<span class="token punctuation">.</span>clearMarks <span class="token operator">&amp;&amp;</span>
    perf<span class="token punctuation">.</span>clearMeasures
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">mark</span> <span class="token operator">=</span> tag <span class="token operator">=&gt;</span> perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
    <span class="token function-variable function">measure</span> <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> startTag<span class="token punctuation">,</span> endTag<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      perf<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> startTag<span class="token punctuation">,</span> endTag<span class="token punctuation">)</span>
      perf<span class="token punctuation">.</span><span class="token function">clearMarks</span><span class="token punctuation">(</span>startTag<span class="token punctuation">)</span>
      perf<span class="token punctuation">.</span><span class="token function">clearMarks</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
      perf<span class="token punctuation">.</span><span class="token function">clearMeasures</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然而，变量 <code>mark</code> 只有在特定的情况下才被定义。首先，我们检查下当前环境是否是浏览器。如果是浏览器的话，又因为 <code>&amp;&amp;</code> 连接符把后面的表达式连接一体，所以检查下 <code>window.performance</code> 是否存在，若存在，就把它赋值给 <code>perf</code> 变量。</p> <p>为了了解这里到底做了什么，需要我们快速研究下 Window 对象的performance 属性。 据<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/performance" target="_blank" rel="noopener noreferrer">MDN<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>解释：“Web Performance API 允许网页访问某些函数来测量网页和 Web 应用程序的性能，包括 Performance Timeline API，Navigation Timing API，the User Timing API，the Resource Timing API”。 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance" target="_blank" rel="noopener noreferrer"><code>Performance</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 接口是 <code>High Resolution Timing API</code> 的一部分，它可以获取到当前页面中与性能相关的信息。</p> <p><code>Performance</code> 对象中有一系列方法：<code>mark</code> <code>measure</code> <code>clearMarks</code> 和 <code>clearMeasures</code>。</p> <ul><li><code>mark</code>：根据给出 <code>name</code> 值，在浏览器的性能输入缓冲区中创建一个相关的<code>timestamp</code></li> <li><code>measure</code>：在浏览器的指定 start mark 和 end mark 间的性能输入缓冲区中创建一个指定的 <code>timestamp</code></li> <li><code>clearMarks</code>：将给定的 <code>mark</code> 从浏览器的性能输入缓冲区中移除</li> <li><code>clearMeasures</code>：将给定的 <code>measure</code> 从浏览器的性能输入缓冲区中</li></ul> <p>正如 Vue.js 官方文档所说，设置 <code>Vue.config.performance</code>  为 <code>true</code> 以在浏览器开发工具的性能/时间线面板中启用对组件初始化、编译、渲染和打补丁的性能追踪。只适用于开发模式和支持 <code>performance.mark</code> API 的浏览器上。</p> <p>然后呢，我们来看下变量 mark 的初始化：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// ...</span>
<span class="token function-variable function">mark</span> <span class="token operator">=</span> tag <span class="token operator">=&gt;</span> perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
<span class="token comment">// measure = ...</span>
</code></pre></div><p>如果 <code>pref</code> 对象存在，且含有 <code>mark</code> <code>measure</code> <code>clearMarks</code> <code>clearMeasures</code> 方法，那么 Vue 会给变量 <code>mark</code> <code>measure</code> 赋值个函数。</p> <p><code>mark</code> 函数的参数为 <code>tag</code> ，返回值是在浏览器的性能输入缓冲区中创建一个相关的<code>timestamp</code>。</p> <p><code>measure</code> 同理。在浏览器开发者工具中的 <code>performance/timeline</code> 面板里，我们可以通过这个函数获取到性能相关的一些信息。</p> <p>接着分析 <code>Vue.prototype._init</code> 方法。满足了 <code>if</code> 里的所有条件后， Vue 对 <code>startTag</code> 和 <code>endTag</code> 变量赋值，然后把 <code>startTag</code> 作为实参调用 <code>mark</code> 函数。这就会在浏览器的性能输入缓冲区中创建一个相关的 <code>timestamp</code> 。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  startTag <span class="token operator">=</span> <span class="token template-string"><span class="token string">`vue-perf-start:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  endTag <span class="token operator">=</span> <span class="token template-string"><span class="token string">`vue-perf-end:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  <span class="token function">mark</span><span class="token punctuation">(</span>startTag<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <p><code>._init</code> 接下来在 Vue 实例对象中添加了 <code>_isVue</code> 属性，并设置为 <code>true</code> ，作一个 flag 以防止被观察到：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// a flag to avoid this being observed</span>
vm<span class="token punctuation">.</span>_isVue <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre></div><hr> <p>然后，<code>._init</code> 方法检测 <code>options</code> 是否存在。前面提过，参数 <code>options</code> 是在创建一个新的 Vue 实例时传给 Vue 构造函数的——所以，<code>Vue.prototype</code> 上的 <code>._init</code> 方法里可以访问到此参数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Vue</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在检测过 <code>options</code> 是否存在后，<code>._init</code> 方法接着校验 <code>options._isComponent</code> 是否为 <code>true</code> ：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>_isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// optimize internal component instantiation</span>
  <span class="token comment">// since dynamic options merging is pretty slow, and none of the</span>
  <span class="token comment">// internal component options needs special treatment.</span>
  <span class="token function">initInternalComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 Vue.js 的源码中，只在一处实例中 <code>options._isComponent</code> 设置为了 <code>true</code> ——函数 <code>createComponentInstanceForVnode</code> 中：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createComponentInstanceForVnode</span> <span class="token punctuation">(</span>
  vnode<span class="token punctuation">:</span> any<span class="token punctuation">,</span> <span class="token comment">// we know it's MountedComponentVNode but flow doesn't</span>
  parent<span class="token punctuation">:</span> any<span class="token punctuation">,</span> <span class="token comment">// activeInstance in lifecycle state</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Component <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options<span class="token punctuation">:</span> InternalComponentOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    _isComponent<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    _parentVnode<span class="token punctuation">:</span> vnode<span class="token punctuation">,</span>
    parent
  <span class="token punctuation">}</span>
  <span class="token comment">// check inline-template render functions</span>
  <span class="token keyword">const</span> inlineTemplate <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>inlineTemplate
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>inlineTemplate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span>render <span class="token operator">=</span> inlineTemplate<span class="token punctuation">.</span>render
    options<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> inlineTemplate<span class="token punctuation">.</span>staticRenderFns
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">vnode<span class="token punctuation">.</span>componentOptions<span class="token punctuation">.</span>Ctor</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>后续我们会讲到 <code>createComponentInstanceForVnode</code> 函数。先回到 <code>._init</code> 方法上，如果传入了 <code>options</code> 且 <code>options._isComponent</code> 为 <code>true</code> ，就会调用 <code>initInternalComponent</code> 函数，并传入 <code>vm</code>（例如：<code>this</code> / Vue 实例） 和 <code>options</code> 作为参数。</p> <hr> <p><code>initInternalComponent</code> 函数是另一处声明：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initInternalComponent</span> <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> options<span class="token punctuation">:</span> InternalComponentOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>options<span class="token punctuation">)</span>
  <span class="token comment">// doing this because it's faster than dynamic enumeration.</span>
  <span class="token keyword">const</span> parentVnode <span class="token operator">=</span> options<span class="token punctuation">.</span>_parentVnode
  opts<span class="token punctuation">.</span>parent <span class="token operator">=</span> options<span class="token punctuation">.</span>parent
  opts<span class="token punctuation">.</span>_parentVnode <span class="token operator">=</span> parentVnode

  <span class="token keyword">const</span> vnodeComponentOptions <span class="token operator">=</span> parentVnode<span class="token punctuation">.</span>componentOptions
  opts<span class="token punctuation">.</span>propsData <span class="token operator">=</span> vnodeComponentOptions<span class="token punctuation">.</span>propsData
  opts<span class="token punctuation">.</span>_parentListeners <span class="token operator">=</span> vnodeComponentOptions<span class="token punctuation">.</span>listeners
  opts<span class="token punctuation">.</span>_renderChildren <span class="token operator">=</span> vnodeComponentOptions<span class="token punctuation">.</span>children
  opts<span class="token punctuation">.</span>_componentTag <span class="token operator">=</span> vnodeComponentOptions<span class="token punctuation">.</span>tag

  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    opts<span class="token punctuation">.</span>render <span class="token operator">=</span> options<span class="token punctuation">.</span>render
    opts<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> options<span class="token punctuation">.</span>staticRenderFns
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>函数 <code>initInternalComponent</code> 声明了个 <code>opts</code> 变量，又在 Vue 对象上添加了个 <code>$options</code> 属性，值都是一个原型 <code>__proto__</code> 为 <code>vm.constructor.options</code> 的新对象：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initInternalComponent</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>options<span class="token punctuation">)</span>
  <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>initInternalComponent</code> 函数然后给新对象 <code>opts</code> 设置了一系列默认值。如注释所讲，这样比动态枚举的效率高。</p> <p>最后，在 <code>options.render</code> 为 <code>true</code> 的情况下，<code>initInternalComponent</code> 函数在 <code>opts</code> 对象上设置两个和渲染相关的属性。</p> <hr> <p>回到 <code>initMixin</code> 函数上，如果 <code>options</code> 或 <code>options._isComponent</code> 有一个为 <code>false</code>，<code>initMixin</code> 设置个 <code>$options</code> 属性，值为 <code>mergeOptions</code> 函数的返回结果，<code>mergeOptions</code> 有3个参数：</p> <ol><li>参数为 <code>vm.constructor</code> （Vue 实例的构造函数）的 <code>resolveConstructorOptions</code> 方法；</li> <li><code>options</code> 或者 一个空对象</li> <li><code>vm</code> （Vue 实例）</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// ...</span>
vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
  <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>
  options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  vm
<span class="token punctuation">)</span>
<span class="token comment">// ...</span>
</code></pre></div><p><a href="https://github.com/ohhoney1/Vue.js-Source-Code-line-by-line/blob/master/docs/03-the-mergeOptions-function-1.md" target="_blank" rel="noopener noreferrer">下一章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，继续分析 <code>initMixin</code> 函数：研究下 <code>mergeOptions</code> 函数。</p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/ohhoney1/Vue.js-Source-Code-line-by-line/edit/master/docs/02-the-initMixin-function.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">1/24/2019, 1:44:12 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/Vue.js-Source-Code-line-by-line/01-the-vue-object-constructor-function.html" class="prev">
          01. Vue 的构造函数
        </a></span> <span class="next"><a href="/Vue.js-Source-Code-line-by-line/03-the-mergeOptions-function-1.html">
          03. mergeOptions 函数(1)
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/Vue.js-Source-Code-line-by-line/assets/js/app.4e4e2843.js" defer></script><script src="/Vue.js-Source-Code-line-by-line/assets/js/4.904b87d0.js" defer></script>
  </body>
</html>
